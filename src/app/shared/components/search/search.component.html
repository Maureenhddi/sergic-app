<section class="search-section">
  <div class="search-hero">
    <h1 class="search-title">
      Trouvez le bien
      <span class="highlight">idéal</span>
    </h1>
  </div>

  <form class="search-form" (ngSubmit)="onSubmit()">
    <!-- Onglets Achat/Location/Vacances -->
    <div class="contract-tabs">
      <button
        type="button"
        class="contract-tab"
        [class.active]="contractType() === 'achat'"
        (click)="updateContractType('achat')"
      >
        Achat
      </button>
      <button
        type="button"
        class="contract-tab"
        [class.active]="contractType() === 'location'"
        (click)="updateContractType('location')"
      >
        Location
      </button>
      <button
        type="button"
        class="contract-tab"
        [class.active]="contractType() === 'vacance'"
        (click)="updateContractType('vacance')"
      >
        Vacances
      </button>
    </div>

    <!-- Barre de recherche avec bouton géoloc et recherche -->
    <div class="search-bar">
      <button
        type="button"
        class="geo-btn"
        [class.active]="geoActive()"
        [class.locating]="geoLocating()"
        (click)="onLocateUser()"
        aria-label="Me géolocaliser"
        [attr.title]="geoActive() ? 'Géolocalisation active' : 'Me géolocaliser'"
      >
        @if (geoLocating()) {
          <div class="geo-spinner"></div>
        } @else {
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
          </svg>
        }
      </button>
      <div class="search-input-wrapper">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        @if (geoActive()) {
          <span class="geo-location-text">Ma position</span>
        } @else {
          <input
            type="text"
            class="search-input"
            placeholder="Ville, code postal..."
            [ngModel]="query()"
            (ngModelChange)="updateQuery($event)"
            name="query"
            aria-label="Rechercher une ville ou code postal"
          />
        }
        @if (showRadiusBadge()) {
          <select class="radius-badge-select" [value]="searchRadius()" (change)="onRadiusChange($event)">
            <option value="5">5 km</option>
            <option value="10">10 km</option>
            <option value="20">20 km</option>
            <option value="50">50 km</option>
            <option value="100">100 km</option>
          </select>
        }
      </div>
      <button type="submit" class="search-btn" aria-label="Rechercher">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </button>
    </div>

    <!-- Bouton filtres -->
    <div class="filters-toggle-wrapper">
      <button type="button" class="filter-toggle" [class.active]="hasActiveFilters" (click)="toggleFilters($event)" [attr.aria-expanded]="showFilters()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="4" y1="21" x2="4" y2="14"/>
          <line x1="4" y1="10" x2="4" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="12"/>
          <line x1="12" y1="8" x2="12" y2="3"/>
          <line x1="20" y1="21" x2="20" y2="16"/>
          <line x1="20" y1="12" x2="20" y2="3"/>
          <line x1="1" y1="14" x2="7" y2="14"/>
          <line x1="9" y1="8" x2="15" y2="8"/>
          <line x1="17" y1="16" x2="23" y2="16"/>
        </svg>
        <span>Filtres</span>
        @if (activeFiltersCount > 0) {
          <span class="filter-count">{{ activeFiltersCount }}</span>
        }
      </button>
    </div>

    <div class="search-filters-wrapper" [class.open]="showFilters()" #filtersWrapper>
      <div class="search-filters">
        <!-- Filtres de base -->
        <div class="filters-row">
          <div class="filter-group">
            <label class="filter-label" for="property-type">Type de bien</label>
            <select
              id="property-type"
              class="filter-select"
              [ngModel]="placeType() ?? ''"
              (ngModelChange)="updatePlaceType($event)"
              name="placeType"
            >
              @for (type of propertyTypes; track type.value) {
                <option [value]="type.value ?? ''">{{ type.label }}</option>
              }
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="surface">Surface</label>
            <select
              id="surface"
              class="filter-select"
              [ngModel]="getSurfaceRangeValue()"
              (ngModelChange)="updateSurfaceRange($event)"
              name="surface"
            >
              @for (range of surfaceRanges; track range.label) {
                <option [value]="range.min + '-' + range.max">{{ range.label }}</option>
              }
            </select>
          </div>
        </div>

        <!-- Prix Range Slider -->
        <div class="filter-group price-range-group">
          <label class="filter-label">
            Prix
            <span class="price-range-value">
              {{ formatPrice(priceMin()) }} — {{ formatPrice(priceMax()) || 'Max' }}
            </span>
          </label>
          <div class="range-slider-container">
            <div class="range-track">
              <div
                class="range-fill"
                [style.left.%]="getRangeLeftPercent()"
                [style.width.%]="getRangeWidthPercent()"
              ></div>
            </div>
            <input
              type="range"
              class="range-input range-min"
              [min]="0"
              [max]="getMaxPriceForRange()"
              [step]="getPriceStep()"
              [ngModel]="priceMin() ?? 0"
              (ngModelChange)="updatePriceMinFromRange($event)"
              name="priceMinRange"
            />
            <input
              type="range"
              class="range-input range-max"
              [min]="0"
              [max]="getMaxPriceForRange()"
              [step]="getPriceStep()"
              [ngModel]="priceMax() ?? getMaxPriceForRange()"
              (ngModelChange)="updatePriceMaxFromRange($event)"
              name="priceMaxRange"
            />
          </div>
          <div class="range-labels">
            <span>0 €</span>
            <span>{{ getMaxPriceForRange() | number:'1.0-0' }} €{{ contractType() === 'location' ? '/mois' : contractType() === 'vacance' ? '/nuit' : '' }}</span>
          </div>
        </div>

        <!-- Nombre de pièces -->
        <div class="filter-group">
          <label class="filter-label">Nombre de pièces</label>
          <select
            class="filter-select"
            [ngModel]="getPiecesRangeValue()"
            (ngModelChange)="updatePiecesRange($event)"
            name="nbPieces"
          >
            @for (range of piecesRanges; track range.label) {
              <option [value]="range.min + '-' + range.max">{{ range.label }}</option>
            }
          </select>
        </div>

        @if (hasActiveFilters) {
          <div class="filters-footer">
            <button type="button" class="clear-filters-btn" (click)="clearFilters()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Effacer les filtres
            </button>
            <button type="submit" class="apply-filters-btn">
              Appliquer
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </button>
          </div>
        }
      </div>
    </div>
  </form>
</section>
