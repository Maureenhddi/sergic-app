<app-header />

<!-- Offline banner -->
@if (offlineCacheService.isOffline()) {
  <div class="offline-banner">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="1" y1="1" x2="23" y2="23"/>
      <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/>
      <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/>
      <path d="M10.71 5.05A16 16 0 0 1 22.58 9"/>
      <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/>
      <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
      <line x1="12" y1="20" x2="12.01" y2="20"/>
    </svg>
    <span>Mode hors ligne - Affichage des annonces en cache</span>
  </div>
}

<app-search
  [geoLocating]="locatingUser()"
  [geoActive]="geoFilterEnabled()"
  [searchRadius]="searchRadius()"
  (search)="onSearch($event)"
  (locateUser)="toggleGeoFilter()"
  (radiusChange)="onRadiusChange($event)"
/>

<!-- Pull to refresh indicator -->
@if (isRefreshing()) {
  <div class="pull-refresh-indicator">
    <div class="loader-spinner"></div>
    <span>Actualisation...</span>
  </div>
}

<main class="main-content"
  (touchstart)="onPullStart($event)"
  (touchmove)="onPullMove($event)"
  (touchend)="onPullEnd()">
  <div class="container">
    <div class="results-header">
      <h2 class="results-title">
        @if (loading()) {
          Recherche en cours...
        } @else {
          <span class="count">{{ resultsCount() }}</span> bien{{ resultsCount() > 1 ? 's' : '' }} trouvé{{ resultsCount() > 1 ? 's' : '' }}
        }
      </h2>
      <div class="header-actions">
        <!-- View toggle -->
        <div class="view-toggle">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="viewMode() === 'list'"
            (click)="toggleView('list')"
            title="Vue liste"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            <span class="btn-label">Liste</span>
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="viewMode() === 'map'"
            (click)="toggleView('map')"
            title="Vue carte"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
              <line x1="8" y1="2" x2="8" y2="18"/>
              <line x1="16" y1="6" x2="16" y2="22"/>
            </svg>
            <span class="btn-label">Carte</span>
          </button>
        </div>
        <label for="sort" class="sr-only">Trier par</label>
        <select id="sort" class="sort-select" [value]="sortBy()" (change)="onSortChange($event)">
          <option value="recent">Plus récents</option>
          <option value="price-asc">Prix croissant</option>
          <option value="price-desc">Prix décroissant</option>
          <option value="surface">Surface</option>
        </select>
      </div>
    </div>

    @if (loading()) {
      <div class="loading-state" role="status" aria-live="polite">
        <div class="loading-grid">
          @for (i of [1, 2, 3, 4, 5, 6]; track i) {
            <div class="skeleton-card">
              <div class="skeleton-image"></div>
              <div class="skeleton-content">
                <div class="skeleton-line wide"></div>
                <div class="skeleton-line medium"></div>
                <div class="skeleton-line short"></div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    @if (error()) {
      <div class="error-state" role="alert">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h3>Une erreur est survenue</h3>
        <p>{{ error() }}</p>
        <button type="button" class="retry-btn" (click)="ngOnInit()">Réessayer</button>
      </div>
    }

    @if (!loading() && !error()) {
      <!-- Map View -->
      @if (viewMode() === 'map') {
        <div class="map-view">
          <div #mapContainer class="search-map-container"></div>
        </div>
      }

      <!-- List View -->
      @if (viewMode() === 'list') {
        <ul class="announcements-grid" role="list">
          @for (announcement of visibleAnnouncements(); track $index) {
            <li>
              <app-announcement-card [announcement]="announcement" />
            </li>
          } @empty {
            <li class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <h3>Aucun résultat</h3>
              <p>Modifiez vos critères de recherche pour trouver des biens</p>
            </li>
          }
        </ul>

        <!-- Scroll anchor & loader -->
        @if (hasMore()) {
          <div #scrollAnchor class="scroll-loader">
            @if (loadingMore()) {
              <div class="loader-spinner"></div>
              <span>Chargement...</span>
            }
          </div>
        }
      }
    }
  </div>
</main>

<footer class="footer desktop-only">
  <div class="container">
    <p>&copy; 2024 Sergic - Tous droits réservés</p>
  </div>
</footer>

<app-bottom-nav
  [showViewToggle]="true"
  [viewMode]="viewMode()"
  (viewToggle)="toggleView($event)"
/>
