<app-header />

<app-search (search)="onSearch($event)" />

<main class="main-content">
  <div class="container">
    <div class="results-header">
      <h2 class="results-title">
        @if (loading()) {
          Recherche en cours...
        } @else {
          <span class="count">{{ resultsCount() }}</span> bien{{ resultsCount() > 1 ? 's' : '' }} trouvé{{ resultsCount() > 1 ? 's' : '' }}
        }
      </h2>
      <div class="header-actions">
        <!-- Géolocalisation -->
        <div class="geo-controls">
          <button
            type="button"
            class="geo-btn"
            [class.active]="geoFilterEnabled()"
            [class.loading]="locatingUser()"
            (click)="toggleGeoFilter()"
            [title]="geoFilterEnabled() ? 'Désactiver le filtre géographique' : 'Me localiser'"
          >
            @if (locatingUser()) {
              <svg class="spinner" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" stroke-dasharray="30 60"/>
              </svg>
            } @else {
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
              </svg>
            }
            @if (geoFilterEnabled()) {
              <span>Autour de moi</span>
            } @else {
              <span>Me localiser</span>
            }
          </button>
          @if (geoFilterEnabled()) {
            <select class="radius-select" [value]="searchRadius()" (change)="updateRadius($event)">
              <option value="5">5 km</option>
              <option value="10">10 km</option>
              <option value="20">20 km</option>
              <option value="50">50 km</option>
              <option value="100">100 km</option>
            </select>
          }
        </div>

        <!-- View toggle -->
        <div class="view-toggle">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="viewMode() === 'list'"
            (click)="toggleView('list')"
            title="Vue liste"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Liste
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="viewMode() === 'map'"
            (click)="toggleView('map')"
            title="Vue carte"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
              <line x1="8" y1="2" x2="8" y2="18"/>
              <line x1="16" y1="6" x2="16" y2="22"/>
            </svg>
            Carte
          </button>
        </div>
        <div class="sort-options">
          <label for="sort" class="sr-only">Trier par</label>
          <select id="sort" class="sort-select">
            <option value="recent">Plus récents</option>
            <option value="price-asc">Prix croissant</option>
            <option value="price-desc">Prix décroissant</option>
            <option value="surface">Surface</option>
          </select>
        </div>
      </div>
    </div>

    @if (loading()) {
      <div class="loading-state" role="status" aria-live="polite">
        <div class="loading-grid">
          @for (i of [1, 2, 3, 4, 5, 6]; track i) {
            <div class="skeleton-card">
              <div class="skeleton-image"></div>
              <div class="skeleton-content">
                <div class="skeleton-line wide"></div>
                <div class="skeleton-line medium"></div>
                <div class="skeleton-line short"></div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    @if (error()) {
      <div class="error-state" role="alert">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h3>Une erreur est survenue</h3>
        <p>{{ error() }}</p>
        <button type="button" class="retry-btn" (click)="ngOnInit()">Réessayer</button>
      </div>
    }

    @if (!loading() && !error()) {
      <!-- Map View -->
      @if (viewMode() === 'map') {
        <div class="map-view">
          <div #mapContainer class="search-map-container"></div>
        </div>
      }

      <!-- List View -->
      @if (viewMode() === 'list') {
        <ul class="announcements-grid" role="list">
          @for (announcement of visibleAnnouncements(); track announcement.reference) {
            <li class="announcement-card">
              <article>
                <div class="card-image">
                  @if (announcement.picture) {
                    <img
                      [src]="getImageUrl(announcement.picture)"
                      [alt]="announcement.label_type + ' à ' + announcement.city"
                      loading="lazy"
                    />
                  }
                  <span class="card-badge" [class.rental]="announcement.contract_type === 'location'">
                    {{ getContractLabel(announcement.contract_type) }}
                  </span>
                  <button type="button" class="favorite-btn" aria-label="Ajouter aux favoris">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                  </button>
                </div>

                <div class="card-content">
                  <div class="card-header">
                    <span class="card-type">{{ announcement.label_type }} - {{ announcement.place_type | titlecase }}</span>
                    <span class="card-ref">Réf. {{ announcement.reference }}</span>
                  </div>

                  <p class="card-price">{{ announcement.price | number:'1.0-0' }} €</p>

                  <div class="card-features">
                    <span class="feature">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                      </svg>
                      {{ announcement.square_meter }} m²
                    </span>
                  </div>

                  <div class="card-location">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                      <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <span>{{ announcement.zip_code }} {{ announcement.city }}</span>
                  </div>

                  <a [routerLink]="['/annonces', announcement.slug]" class="card-link">
                    Voir l'annonce
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                  </a>
                </div>
              </article>
            </li>
          } @empty {
            <li class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <h3>Aucun résultat</h3>
              <p>Modifiez vos critères de recherche pour trouver des biens</p>
            </li>
          }
        </ul>

        <!-- Scroll anchor & loader -->
        @if (hasMore()) {
          <div #scrollAnchor class="scroll-loader">
            @if (loadingMore()) {
              <div class="loader-spinner"></div>
              <span>Chargement...</span>
            }
          </div>
        }
      }
    }
  </div>
</main>

<footer class="footer">
  <div class="container">
    <p>&copy; 2024 Sergic - Tous droits réservés</p>
  </div>
</footer>
